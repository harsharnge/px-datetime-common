<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="validate.html" />
<link rel="import" href="px-datetime-imports.html" />
<link rel="import" href="px-datetime-behavior.html" />
<link rel="import" href="px-datetime-entry-cell.html" />
<link rel="import" href="../polymer-font-awesome/polymer-font-awesome.html" />


<!--
Range field component which displays a time or date and font awesome icon.

##### Usage

    <px-datetime-entry moment="{{...}}" date-or-time="Date">
    </px-datetime-entry>

-->
<dom-module id="px-datetime-entry">
  <link rel="import" type="css" href="css/px-datetime-entry.css"/>
  <template>
    <div class="range-field__field">
      <div id='wrapper'>
        <label class="label--inline">
          <span class="a11y dtLabel">{{dateOrTime}}</span>
          <iron-icon
            id="icon"
            class="fa fa-fw dtIcon"
            icon="[[_setIcon(dateOrTime)]]">
          </iron-icon>
        </label>
          <template is="dom-repeat" items="{{_cellFormatArray}}">
            <px-datetime-entry-cell
              id="cell{{index}}"
              class="cell"
              order='{{index}}'
              moment-obj="[[momentObj]]"
              moment-format='[[item]]'
              symbol=[[_returnSymbol(index)]]>
            </px-datetime-entry-cell>
            <template is="dom-if" if={{_isSymbol(index)}}>
              <span
                class="dtEntrySymbol"
                symbol='{{_returnSymbol(index)}}'>{{_returnSymbol(index)}}
              </span>
            </template>
          </template>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-datetime-entry',

    behaviors: [
      pxDatetimeBehavior,
      validate,
    ],

    properties: {
      /**
       * Date or Time icon/text
       *
       * Format is 'Date' or 'Time'
       *
       * Can only be configured statically; not data-bindable
       *
       * @property dateOrTime
       * @type string
       * @default none
       */
      dateOrTime: {
        type: String
      },
      /**
       *
       * Moment format string for the format to display/validate this field against (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       * Can only be configured statically; not data-bindable
       *
       * @private
       */
      momentFormat: {
        type: String
      },

      _editTimeout:{
        type:Object,
        value: function(){ return {} }
      },
      /**
       * A flag that turns on inline edit, changing the input styles
       *
       * @property inlineEdit
       * @type Boolean
       * @default false
       */
      inlineEdit: {
        type: Boolean,
        value: false
      },
      _cellFormatArray:{
        type: Array,
        notify: true
      },
      _symbolCharArray:{
        type: Array,
        notify: true,
        value: function(){
          return []
        }
      }
    },

    listeners: {
      'entry-cell-move': '_entryCellMove',
      'cell-focused': '_handleFocus',
      'cell-blured': '_handleBlur',
    },

    ready: function(){
      // dateFormat()
      this._splitFormat();
    },

    _splitFormat:function(){
      // this.momentFormat.indexOf('MM');

      // console.log(this.momentFormat.indexOf('MM'));
      // var re = /\w+\s/g;

      var re = /[MDYAaHhkmsSzZXx]+/g;
      var reSymbol = /\W+/g;

      this._cellFormatArray = this.momentFormat.match(re);
      this._symbolCharArray = this.momentFormat.match(reSymbol);

      this.notifyPath('_cellFormatArray',this._cellFormatArray);
      this.notifyPath('_symbolCharArray',this._symbolCharArray);
    },

    _isSymbol: function(i){
      if(this._symbolCharArray === null || typeof(this._symbolCharArray[i]) === 'undefined'){
        return false
      }
      return true
    },

    _returnSymbol: function(i){
      if(this._symbolCharArray === null || typeof(this._symbolCharArray[i]) === 'undefined'){
        return ''
      }
      return this._symbolCharArray[i].split(' ').join('\xa0');
    },

    _setIcon: function(){
      if (this.dateOrTime.toLowerCase() === 'date') {
        return 'polymer-font-awesome:fa-calendar'
      } else {
        return 'polymer-font-awesome:fa-clock-o'
      }
    },

    _entryCellMove: function(evt){
      var ne = Polymer.dom(evt);
      var entryCellOrder = ne.rootTarget.order;

      if(this.dateOrTime.toLowerCase() === 'date' && entryCellOrder === 3){
        // fire something up to advance to next entry

        // TODO what if dev set does not have AM PM aka 24 hour clock has three boxes, not 4
      } else if(this.dateOrTime.toLowerCase() === 'time' && entryCellOrder === 4){
        // fire something up to advance to next entry
      }else{
        entryCellOrder = parseInt(entryCellOrder) + 1;
        var elem = this.$$("#cell" + entryCellOrder);
        elem.$.dtEntry.focus();
      }
    },

    _handleFocus: function(){
      if(this.inlineEdit){
        this.toggleClass('text-input', true, this.$.wrapper);
      }
    },
    _handleBlur: function(){
      console.log('entry blur');
      this._validateInput();

      if(this.inlineEdit){
        this.toggleClass('text-input', false, this.$.wrapper);
      }
    }
  });
</script>
